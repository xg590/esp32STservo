# å¯¹è¯

```md
æˆ‘çš„æ­¥è¿›ç”µæœºçš„ç£ç¼–ç å™¨çš„è§’åº¦è¯»æ•°èŒƒå›´æ˜¯0-4095ï¼Œå‡åŒ€åœ°å¯¹åº”äºç”µæœºè½¬åŠ¨è§’åº¦çš„0-360åº¦ã€‚å½“é¡ºæ—¶é’ˆå¤šåœˆè½¬åŠ¨æ—¶ï¼Œè¯»æ•°ä¸æ–­å¢å¤§ï¼Œç›´åˆ°è¶…è¿‡ä¸€åœˆæ—¶ä»4095è·³å˜å›0ï¼Œç„¶åå†æ¬¡ä¸æ–­å¢å¤§ï¼Œå½“é€†æ—¶é’ˆå¤šåœˆè½¬åŠ¨æ—¶ï¼Œè¯»æ•°ä¸æ–­å‡å°ï¼Œç›´åˆ°ä»0è·³å˜ä¸º4095ï¼Œç„¶åå†æ¬¡ä¸æ–­å‡å°ã€‚å¸®æˆ‘å†™æ®µpythonä»£ç ï¼Œè®©é¡ºæ—¶é’ˆå¤šåœˆè½¬åŠ¨æ—¶ï¼Œè¯»æ•°è¿ç»­å¢å¤§å¯ä»¥è¶…è¿‡4095ï¼Œè€Œé€†æ—¶é’ˆè½¬åŠ¨æ—¶è¿ç»­å‡å°å¯ä»¥ä¸ºè´Ÿæ•°
```

å¥½çš„ ğŸ‘
ä½ é‡åˆ°çš„æƒ…å†µæ˜¯ **ç»å¯¹è§’åº¦ä¼ æ„Ÿå™¨è¯»æ•°**ï¼ˆ0â€“4095èŒƒå›´å†…å¾ªç¯ï¼‰ï¼Œéœ€è¦è½¬æ¢ä¸º **è¿ç»­è§’åº¦å€¼**ï¼ˆå¯ä»¥è·¨å¤šåœˆï¼‰ã€‚
è¿™å…¶å®å°±æ˜¯ä¸€ä¸ª **unwrapï¼ˆè§£åŒ…ï¼‰è§’åº¦** çš„é—®é¢˜ã€‚

ä¸‹é¢ç»™ä½ ä¸€æ®µ Python ä»£ç ï¼Œèƒ½æŠŠç£ç¼–ç å™¨çš„åŸå§‹è¯»æ•°æ˜ å°„åˆ°è¿ç»­è§’åº¦ï¼š

```python
class EncoderUnwrapper:
    def __init__(self, curr_posi=0, abs_max_posi=4095):
        self.last_raw     = None           # ä¸Šä¸€æ¬¡åŸå§‹è¯»æ•°
        self.posi         = curr_posi      # ç´¯è®¡ä½ç½®ï¼ˆå•ä½ï¼šæ­¥ï¼‰
        self.total_step = abs_max_posi + 1 # ç¼–ç å™¨ï¼ˆ0~4095ï¼‰ä¸€åœˆå…±4096æ­¥

    def update(self, raw_value):
        """
        è¾“å…¥ç¼–ç å™¨åŸå§‹è¯»æ•° (0 ~ 4095)ï¼Œè¿”å›è¿ç»­çš„ç´¯ç§¯ä½ç½®ï¼ˆå¯æ­£å¯è´Ÿï¼‰
        """
        if self.last_raw:
            # è®¡ç®—ç›¸å¯¹å˜åŒ–é‡
            delta = raw_value - self.last_raw
    
            # å¤„ç†è·³å˜ï¼šå¦‚æœè·¨è¿‡äº†0ç‚¹ï¼ˆé¡ºæ—¶é’ˆ4095->0 æˆ– é€†æ—¶é’ˆ0->4095ï¼‰
            if  delta  >  self.total_step // 2:  # é€†å‘è·³å˜
                # å‡è®¾é€†æ—¶é’ˆè½¬ï¼Œè·³å˜å‰100ï¼Œè·³å˜å4000ï¼Œdeltaä¸ºæ­£3900ï¼Œæ˜¾è‘—å¤§äºæœ€å¤§æ­¥æ•°çš„ä¸€åŠ
                delta -=  self.total_step
            elif delta < -self.total_step // 2:  # é¡ºå‘è·³å˜
                # å‡è®¾é¡ºæ—¶é’ˆè½¬ï¼Œè·³å˜å‰4000ï¼Œè·³å˜å100ï¼Œdeltaä¸ºè´Ÿ
                delta +=  self.total_step
    
            # ç´¯åŠ 
            self.posi += delta
            self.last_raw = raw_value
        
        else:
            # ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œåˆå§‹åŒ–
            self.last_raw = raw_value 

    def get_degrees(self):
        """è¿”å›ç´¯è®¡è§’åº¦ï¼Œå•ä½ï¼šåº¦"""
        return self.posi * (360.0 / self.total_step)


# ==== ä½¿ç”¨ç¤ºä¾‹ ====
if __name__ == "__main__":
    encoder = EncoderUnwrapper()

    # æ¨¡æ‹ŸåŸå§‹è¯»æ•°å˜åŒ–ï¼ˆé¡ºæ—¶é’ˆè½¬è¿‡ä¸€åœˆå¤šä¸€äº›ï¼‰
    raw_values = [1, 1000, 2500, 4000, 4090, 4092, 4095, 2, 10, 100, 500, 1000, 2000, 3000, 1]
    for raw in raw_values:
        encoder.update(raw)
        deg = encoder.get_degrees()
        print(f"raw={raw:4d},  posi={encoder.posi:6d},  deg={deg:8.2f}")
```
